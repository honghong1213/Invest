import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import ta
import ssl
import certifi
from pykrx import stock

# SSL Ïù∏Ï¶ùÏÑú Î¨∏Ï†ú Ìï¥Í≤∞
ssl._create_default_https_context = ssl._create_unverified_context

# ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï
st.set_page_config(
    page_title="Í∏ÄÎ°úÎ≤å Ìà¨Ïûê ÎåÄÏãúÎ≥¥Îìú",
    page_icon="üìà",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ÏûêÏÇ∞ Ï†ïÏùò
ASSETS = {
    "Ï£ºÍ∞ÄÏßÄÏàò": {
        "üá∞üá∑ KOSPI": "^KS11",
        "üá∫üá∏ S&P 500": "^GSPC",
        "üá∫üá∏ ÎÇòÏä§Îã•": "^IXIC",
        "üá∫üá∏ Îã§Ïö∞Ï°¥Ïä§": "^DJI",
        "üá®üá≥ ÏÉÅÌï¥Ï¢ÖÌï©": "000001.SS",
        "üáØüáµ ÎãõÏºÄÏù¥225": "^N225",
        "üá©üá™ DAX": "^GDAXI",
        "üá¨üáß FTSE 100": "^FTSE",
    },
    "Ï±ÑÍ∂å": {
        "ÎØ∏Íµ≠ 10ÎÖÑ Íµ≠Ï±Ñ": "^TNX",
        "ÎØ∏Íµ≠ 2ÎÖÑ Íµ≠Ï±Ñ": "^IRX",
        "ÎØ∏Íµ≠ 30ÎÖÑ Íµ≠Ï±Ñ": "^TYX",
    },
    "ÏÉÅÌíà": {
        "Í∏à (Gold)": "GC=F",
        "ÏùÄ (Silver)": "SI=F",
        "WTI ÏõêÏú†": "CL=F",
        "Ï≤úÏó∞Í∞ÄÏä§": "NG=F",
        "Íµ¨Î¶¨": "HG=F",
    },
    "ÏïîÌò∏ÌôîÌèê": {
        "ÎπÑÌä∏ÏΩîÏù∏": "BTC-USD",
        "Ïù¥ÎçîÎ¶¨ÏõÄ": "ETH-USD",
    }
}

# Ï∫êÏãúÎ•º ÏÇ¨Ïö©Ìïú Îç∞Ïù¥ÌÑ∞ Î°úÎî©
@st.cache_data(ttl=300)  # 5Î∂Ñ Ï∫êÏãú
def load_data(ticker, period="1y"):
    """
    Ìã∞Ïª§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    """
    try:
        # SSL Í≤ÄÏ¶ù ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú
        data = yf.download(ticker, period=period, progress=False)
        if data.empty:
            return None
        
        # Multi-level columnsÏùÑ flatÌïòÍ≤å Î≥ÄÌôò
        if isinstance(data.columns, pd.MultiIndex):
            data.columns = data.columns.get_level_values(0)
        
        return data
    except Exception as e:
        st.error(f"Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: {ticker} - {str(e)}")
        return None

def calculate_indicators(data):
    """
    Í∏∞Ïà†Ï†Å ÏßÄÌëú Í≥ÑÏÇ∞
    """
    df = data.copy()
    
    # Close Ïª¨ÎüºÏù¥ SeriesÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† Î≥ÄÌôò
    close_series = df['Close'].squeeze() if hasattr(df['Close'], 'squeeze') else df['Close']
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ†
    df['MA20'] = close_series.rolling(window=20).mean()
    df['MA50'] = close_series.rolling(window=50).mean()
    df['MA200'] = close_series.rolling(window=200).mean()
    
    # RSI (Í∏∞Í∞Ñ 14, Signal 6)
    rsi_indicator = ta.momentum.RSIIndicator(close_series, window=14)
    df['RSI'] = rsi_indicator.rsi()
    df['RSI_Signal'] = df['RSI'].rolling(window=6).mean()
    
    # MACD (Îã®Í∏∞12, Ïû•Í∏∞26, Signal 9)
    macd = ta.trend.MACD(close_series, window_slow=26, window_fast=12, window_sign=9)
    df['MACD'] = macd.macd()
    df['MACD_Signal'] = macd.macd_signal()
    df['MACD_Hist'] = macd.macd_diff()
    
    # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú (Í∏∞Í∞Ñ 18, ÏäπÏàò 2.0)
    bollinger = ta.volatility.BollingerBands(close_series, window=18, window_dev=2.0)
    df['BB_Upper'] = bollinger.bollinger_hband()
    df['BB_Middle'] = bollinger.bollinger_mavg()
    df['BB_Lower'] = bollinger.bollinger_lband()
    
    # Ïä§ÌÜ†Ï∫êÏä§Ìã± Ïä¨Î°úÏö∞ (Í∏∞Í∞Ñ 10, %K 6, %D 6)
    stoch = ta.momentum.StochasticOscillator(
        high=df['High'].squeeze() if hasattr(df['High'], 'squeeze') else df['High'],
        low=df['Low'].squeeze() if hasattr(df['Low'], 'squeeze') else df['Low'],
        close=close_series,
        window=10,
        smooth_window=6
    )
    df['Stoch_K'] = stoch.stoch()
    df['Stoch_D'] = stoch.stoch_signal()
    
    # ÏùºÎ™©Í∑†ÌòïÌëú (Ichimoku)
    ichimoku = ta.trend.IchimokuIndicator(
        high=df['High'].squeeze() if hasattr(df['High'], 'squeeze') else df['High'],
        low=df['Low'].squeeze() if hasattr(df['Low'], 'squeeze') else df['Low']
    )
    df['Ichimoku_Conversion'] = ichimoku.ichimoku_conversion_line()  # Ï†ÑÌôòÏÑ† (9Ïùº)
    df['Ichimoku_Base'] = ichimoku.ichimoku_base_line()  # Í∏∞Ï§ÄÏÑ† (26Ïùº)
    df['Ichimoku_A'] = ichimoku.ichimoku_a()  # ÏÑ†ÌñâÏä§Ìå¨A
    df['Ichimoku_B'] = ichimoku.ichimoku_b()  # ÏÑ†ÌñâÏä§Ìå¨B
    
    # ÌõÑÌñâÏä§Ìå¨ Í≥ÑÏÇ∞ (ÎãπÏùº Ï¢ÖÍ∞ÄÎ•º 26Ïùº Ï†ÑÏóê ÌëúÏãú)
    df['Ichimoku_Lagging'] = close_series.shift(-26)
    
    return df

def create_chart(data, title):
    """
    PlotlyÎ•º ÏÇ¨Ïö©Ìïú Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Ï∞®Ìä∏ ÏÉùÏÑ±
    """
    # ÏÑúÎ∏åÌîåÎ°Ø ÏÉùÏÑ±: Í∞ÄÍ≤©, Í±∞ÎûòÎüâ, RSI, Stochastic, MACD
    fig = make_subplots(
        rows=5, cols=1,
        shared_xaxes=True,
        vertical_spacing=0.02,
        subplot_titles=(f'{title} Í∞ÄÍ≤©', 'Í±∞ÎûòÎüâ', 'RSI', 'Stochastic Slow', 'MACD'),
        row_heights=[0.4, 0.15, 0.15, 0.15, 0.15]
    )
    
    # Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏ (ÏÉÅÏäπ: Îπ®Í∞ï, ÌïòÎùΩ: ÌååÎûë)
    fig.add_trace(
        go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name='Í∞ÄÍ≤©',
            increasing_line_color='red',
            decreasing_line_color='blue',
            increasing_fillcolor='red',
            decreasing_fillcolor='blue'
        ),
        row=1, col=1
    )
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ†
    fig.add_trace(go.Scatter(x=data.index, y=data['MA20'], name='MA20', line=dict(color='orange', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MA50'], name='MA50', line=dict(color='blue', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MA200'], name='MA200', line=dict(color='red', width=1)), row=1, col=1)
    
    # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Upper'], name='BB Upper', line=dict(color='gray', width=1, dash='dash')), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Lower'], name='BB Lower', line=dict(color='gray', width=1, dash='dash')), row=1, col=1)
    
    # ÏùºÎ™©Í∑†ÌòïÌëú
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Conversion'], name='Ï†ÑÌôòÏÑ†(9)', line=dict(color='cyan', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Base'], name='Í∏∞Ï§ÄÏÑ†(26)', line=dict(color='magenta', width=1)), row=1, col=1)
    
    # ÌõÑÌñâÏä§Ìå¨ (26Ïùº Îí§Î°ú Ïù¥Îèô)
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Lagging'], name='ÌõÑÌñâÏä§Ìå¨(26)', line=dict(color='orange', width=1, dash='dot')), row=1, col=1)
    
    # ÏùºÎ™©Í∑†ÌòïÌëú Íµ¨Î¶ÑÎåÄ - ÏñëÏö¥(Îπ®Í∞ï)Í≥º ÏùåÏö¥(ÌååÎûë) Íµ¨Î∂Ñ
    # ÏÑ†ÌñâÏä§Ìå¨AÏôÄ BÎ•º ÎπÑÍµêÌïòÏó¨ ÏÉâÏÉÅ Í≤∞Ï†ï
    for i in range(len(data)):
        if i == 0:
            continue
        
        span_a_curr = data['Ichimoku_A'].iloc[i]
        span_b_curr = data['Ichimoku_B'].iloc[i]
        span_a_prev = data['Ichimoku_A'].iloc[i-1]
        span_b_prev = data['Ichimoku_B'].iloc[i-1]
        
        # ÏñëÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A > ÏÑ†ÌñâÏä§Ìå¨B): Îπ®Í∞ÑÏÉâ
        if span_a_curr >= span_b_curr:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(255, 0, 0, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
        # ÏùåÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A < ÏÑ†ÌñâÏä§Ìå¨B): ÌååÎûÄÏÉâ
        else:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(0, 0, 255, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
    
    # ÏÑ†ÌñâÏä§Ìå¨ ÎùºÏù∏ ÌëúÏãú
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_A'], 
        name='ÏÑ†ÌñâÏä§Ìå¨A', 
        line=dict(color='green', width=1),
        showlegend=True
    ), row=1, col=1)
    
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_B'], 
        name='ÏÑ†ÌñâÏä§Ìå¨B', 
        line=dict(color='red', width=1),
        showlegend=True
    ), row=1, col=1)
    
    # Í±∞ÎûòÎüâ (ÏÉÅÏäπ: Îπ®Í∞ï, ÌïòÎùΩ: ÌååÎûë)
    colors = ['red' if close >= open_ else 'blue' for close, open_ in zip(data['Close'], data['Open'])]
    fig.add_trace(
        go.Bar(x=data.index, y=data['Volume'], name='Í±∞ÎûòÎüâ', marker_color=colors),
        row=2, col=1
    )
    
    # RSI
    fig.add_trace(go.Scatter(x=data.index, y=data['RSI'], name='RSI', line=dict(color='purple', width=2)), row=3, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['RSI_Signal'], name='RSI Signal', line=dict(color='orange', width=1.5)), row=3, col=1)
    fig.add_hline(y=70, line_dash="dash", line_color="red", row=3, col=1)
    fig.add_hline(y=30, line_dash="dash", line_color="green", row=3, col=1)
    
    # Stochastic Slow
    fig.add_trace(go.Scatter(x=data.index, y=data['Stoch_K'], name='%K (6)', line=dict(color='blue', width=2)), row=4, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['Stoch_D'], name='%D (6)', line=dict(color='red', width=2)), row=4, col=1)
    fig.add_hline(y=80, line_dash="dash", line_color="red", row=4, col=1)
    fig.add_hline(y=20, line_dash="dash", line_color="green", row=4, col=1)
    
    # MACD
    fig.add_trace(go.Scatter(x=data.index, y=data['MACD'], name='MACD', line=dict(color='blue', width=2)), row=5, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MACD_Signal'], name='Signal', line=dict(color='red', width=2)), row=5, col=1)
    fig.add_trace(go.Bar(x=data.index, y=data['MACD_Hist'], name='Histogram', marker_color='gray'), row=5, col=1)
    
    # Î†àÏù¥ÏïÑÏõÉ ÏóÖÎç∞Ïù¥Ìä∏
    fig.update_layout(
        height=1200,
        showlegend=True,
        xaxis_rangeslider_visible=False,
        hovermode='x unified'
    )
    
    fig.update_xaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    fig.update_yaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    
    return fig

def create_simple_chart(data, title):
    """
    Í∞ÄÍ≤© Ï∞®Ìä∏Îßå ÏûàÎäî Í∞ÑÎã®Ìïú Ï∞®Ìä∏ ÏÉùÏÑ± (Î≥¥Ï°∞ÏßÄÌëú Ï†úÏô∏)
    """
    fig = go.Figure()
    
    # Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏ (ÏÉÅÏäπ: Îπ®Í∞ï, ÌïòÎùΩ: ÌååÎûë)
    fig.add_trace(
        go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name='Í∞ÄÍ≤©',
            increasing_line_color='red',
            decreasing_line_color='blue',
            increasing_fillcolor='red',
            decreasing_fillcolor='blue'
        )
    )
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ†
    fig.add_trace(go.Scatter(x=data.index, y=data['MA20'], name='MA20', line=dict(color='orange', width=1)))
    fig.add_trace(go.Scatter(x=data.index, y=data['MA50'], name='MA50', line=dict(color='blue', width=1)))
    fig.add_trace(go.Scatter(x=data.index, y=data['MA200'], name='MA200', line=dict(color='red', width=1)))
    
    # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Upper'], name='BB Upper', line=dict(color='gray', width=1, dash='dash')))
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Lower'], name='BB Lower', line=dict(color='gray', width=1, dash='dash')))
    
    # ÏùºÎ™©Í∑†ÌòïÌëú
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Conversion'], name='Ï†ÑÌôòÏÑ†(9)', line=dict(color='cyan', width=1)))
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Base'], name='Í∏∞Ï§ÄÏÑ†(26)', line=dict(color='magenta', width=1)))
    
    # ÌõÑÌñâÏä§Ìå¨ (26Ïùº Îí§Î°ú Ïù¥Îèô)
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Lagging'], name='ÌõÑÌñâÏä§Ìå¨(26)', line=dict(color='orange', width=1, dash='dot')))
    
    # ÏùºÎ™©Í∑†ÌòïÌëú Íµ¨Î¶ÑÎåÄ - ÏñëÏö¥(Îπ®Í∞ï)Í≥º ÏùåÏö¥(ÌååÎûë) Íµ¨Î∂Ñ
    for i in range(len(data)):
        if i == 0:
            continue
        
        span_a_curr = data['Ichimoku_A'].iloc[i]
        span_b_curr = data['Ichimoku_B'].iloc[i]
        span_a_prev = data['Ichimoku_A'].iloc[i-1]
        span_b_prev = data['Ichimoku_B'].iloc[i-1]
        
        # ÏñëÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A > ÏÑ†ÌñâÏä§Ìå¨B): Îπ®Í∞ÑÏÉâ
        if span_a_curr >= span_b_curr:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ))
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(255, 0, 0, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ))
        # ÏùåÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A < ÏÑ†ÌñâÏä§Ìå¨B): ÌååÎûÄÏÉâ
        else:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ))
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(0, 0, 255, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ))
    
    # ÏÑ†ÌñâÏä§Ìå¨ ÎùºÏù∏ ÌëúÏãú
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_A'], 
        name='ÏÑ†ÌñâÏä§Ìå¨A', 
        line=dict(color='green', width=1),
        showlegend=True
    ))
    
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_B'], 
        name='ÏÑ†ÌñâÏä§Ìå¨B', 
        line=dict(color='red', width=1),
        showlegend=True
    ))
    
    # Î†àÏù¥ÏïÑÏõÉ ÏóÖÎç∞Ïù¥Ìä∏
    fig.update_layout(
        title=title,
        height=600,
        showlegend=True,
        xaxis_rangeslider_visible=False,
        hovermode='x unified'
    )
    
    fig.update_xaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    fig.update_yaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    
    return fig

def create_mini_chart(data, title):
    """
    ÎØ∏Îãà Ï∞®Ìä∏ ÏÉùÏÑ± (Ï¢ÖÎ™© Ïä§ÌÅ¨Î¶¨ÎãùÏö©)
    """
    mini_fig = go.Figure()
    mini_fig.add_trace(go.Candlestick(
        x=data.index[-60:],
        open=data['Open'][-60:],
        high=data['High'][-60:],
        low=data['Low'][-60:],
        close=data['Close'][-60:],
        increasing_line_color='red',
        decreasing_line_color='blue',
        increasing_fillcolor='red',
        decreasing_fillcolor='blue',
        showlegend=False,
        name='Í∞ÄÍ≤©'
    ))
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ† Ï∂îÍ∞Ä
    mini_fig.add_trace(go.Scatter(
        x=data.index[-60:],
        y=data['MA20'][-60:],
        name='MA20',
        line=dict(color='orange', width=1)
    ))
    
    # Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Ï∂îÍ∞Ä
    mini_fig.add_trace(go.Scatter(
        x=data.index[-60:],
        y=data['BB_Upper'][-60:],
        name='BBÏÉÅÎã®',
        line=dict(color='gray', width=1, dash='dash'),
        showlegend=False
    ))
    
    mini_fig.add_trace(go.Scatter(
        x=data.index[-60:],
        y=data['BB_Lower'][-60:],
        name='BBÌïòÎã®',
        line=dict(color='gray', width=1, dash='dash'),
        fill='tonexty',
        fillcolor='rgba(128, 128, 128, 0.1)',
        showlegend=False
    ))
    
    # ÌõÑÌñâÏä§Ìå¨ Ï∂îÍ∞Ä
    mini_fig.add_trace(go.Scatter(
        x=data.index[-60:],
        y=data['Ichimoku_Lagging'][-60:],
        name='ÌõÑÌñâÏä§Ìå¨',
        line=dict(color='orange', width=2, dash='dot')
    ))
    
    mini_fig.update_layout(
        title=title,
        height=250,
        margin=dict(l=0, r=0, t=30, b=0),
        xaxis_rangeslider_visible=False,
        showlegend=True,
        legend=dict(
            orientation="h",
            yanchor="bottom",
            y=1.02,
            xanchor="right",
            x=1,
            font=dict(size=8)
        ),
        xaxis=dict(showticklabels=False),
        yaxis=dict(side='right')
    )
    
    return mini_fig

def screen_kospi_stocks():
    """
    KOSPI Ïö∞ÎüâÍ∏∞ÏóÖ Ïä§ÌÅ¨Î¶¨Îãù
    ÎåÄÏÉÅ: KOSPI 200 ÏßÄÏàò Ìé∏ÏûÖ Ï¢ÖÎ™© (ÏãúÍ∞ÄÏ¥ùÏï° ÏÉÅÏúÑ 200Í∞ú ÎåÄÌòïÏ£º)
    Ï°∞Í±¥: 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™©Îßå Îπ†Î•¥Í≤å ÌïÑÌÑ∞ÎßÅ ÌõÑ Ï∞®Ìä∏Î°ú ÌôïÏù∏
    """
    
    try:
        # KOSPI 200 Ï¢ÖÎ™© Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïö∞Îüâ ÎåÄÌòïÏ£ºÎßå)
        today = datetime.now().strftime("%Y%m%d")
        
        # KOSPI 200 ÏßÄÏàò Íµ¨ÏÑ± Ï¢ÖÎ™© Í∞ÄÏ†∏Ïò§Í∏∞
        try:
            kospi200_tickers = stock.get_index_portfolio_deposit_file("1028")  # KOSPI 200 ÏΩîÎìú
            st.info(f"üìä KOSPI 200 Ïö∞ÎüâÍ∏∞ÏóÖ {len(kospi200_tickers)}Í∞ú Ï¢ÖÎ™©ÏóêÏÑú 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™© Í≤ÄÏÉâ Ï§ë...")
        except:
            # Ïã§Ìå® Ïãú ÏãúÍ∞ÄÏ¥ùÏï° ÏÉÅÏúÑ Ï¢ÖÎ™©ÏúºÎ°ú ÎåÄÏ≤¥
            all_tickers = stock.get_market_ticker_list(today, market="KOSPI")
            # ÏãúÍ∞ÄÏ¥ùÏï° Í∏∞Ï§ÄÏúºÎ°ú ÏÉÅÏúÑ 200Í∞ú ÏÑ†ÌÉù
            market_caps = {}
            for ticker in all_tickers[:300]:  # ÏÉÅÏúÑ 300Í∞úÎßå Ï≤¥ÌÅ¨
                try:
                    cap = stock.get_market_cap(today, today, ticker)
                    if not cap.empty:
                        market_caps[ticker] = cap['ÏãúÍ∞ÄÏ¥ùÏï°'].iloc[-1]
                except:
                    continue
            
            # ÏãúÍ∞ÄÏ¥ùÏï° ÏÉÅÏúÑ 200Í∞ú ÏÑ†ÌÉù
            sorted_tickers = sorted(market_caps.items(), key=lambda x: x[1], reverse=True)
            kospi200_tickers = [t[0] for t in sorted_tickers[:200]]
            st.info(f"üìä ÏãúÍ∞ÄÏ¥ùÏï° ÏÉÅÏúÑ {len(kospi200_tickers)}Í∞ú Ïö∞ÎüâÍ∏∞ÏóÖÏóêÏÑú 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™© Í≤ÄÏÉâ Ï§ë...")
        
        # Ï¢ÖÎ™©Î™Ö Í∞ÄÏ†∏Ïò§Í∏∞
        kospi_symbols = {}
        for ticker in kospi200_tickers:
            try:
                name = stock.get_market_ticker_name(ticker)
                # yfinance ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò (6ÏûêÎ¶¨ ÏΩîÎìú.KS)
                kospi_symbols[name] = f"{ticker}.KS"
            except:
                continue
        
    except Exception as e:
        st.warning(f"‚ö†Ô∏è pykrxÎ°ú Ï¢ÖÎ™© Î¶¨Ïä§Ìä∏Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: {str(e)}")
        st.info("üí° Ï£ºÏöî Ïö∞ÎüâÏ£ºÎßåÏúºÎ°ú Î∂ÑÏÑùÏùÑ ÏßÑÌñâÌï©ÎãàÎã§...")
        
        # Ïã§Ìå® Ïãú Ï£ºÏöî Ïö∞ÎüâÏ£ºÎßå ÏÇ¨Ïö© (KOSPI 200 Ï£ºÏöî Ï¢ÖÎ™©)
        kospi_symbols = {
            # IT/Î∞òÎèÑÏ≤¥ ÎåÄÌòïÏ£º
            "ÏÇºÏÑ±Ï†ÑÏûê": "005930.KS", "SKÌïòÏù¥ÎãâÏä§": "000660.KS", "LGÏóêÎÑàÏßÄÏÜîÎ£®ÏÖò": "373220.KS",
            "ÏÇºÏÑ±SDI": "006400.KS", "LGÏ†ÑÏûê": "066570.KS", "ÏÇºÏÑ±Ï†ÑÍ∏∞": "009150.KS",
            "SKÏä§ÌÄòÏñ¥": "402340.KS", "NAVER": "035420.KS", "Ïπ¥Ïπ¥Ïò§": "035720.KS",
            # Î∞îÏù¥Ïò§/Ï†úÏïΩ ÎåÄÌòïÏ£º
            "ÏÇºÏÑ±Î∞îÏù¥Ïò§Î°úÏßÅÏä§": "207940.KS", "ÏÖÄÌä∏Î¶¨Ïò®": "068270.KS", "ÏÖÄÌä∏Î¶¨Ïò®Ìó¨Ïä§ÏºÄÏñ¥": "091990.KS",
            # ÏûêÎèôÏ∞® ÎåÄÌòïÏ£º
            "ÌòÑÎåÄÏ∞®": "005380.KS", "Í∏∞ÏïÑ": "000270.KS", "ÌòÑÎåÄÎ™®ÎπÑÏä§": "012330.KS",
            # ÌôîÌïô/ÏÜåÏû¨ ÎåÄÌòïÏ£º
            "LGÌôîÌïô": "051910.KS", "Ìè¨Ïä§ÏΩîÌôÄÎî©Ïä§": "005490.KS", "SKÏù¥ÎÖ∏Î≤†Ïù¥ÏÖò": "096770.KS",
            "POSCO DX": "022100.KS", "Î°ØÎç∞ÏºÄÎØ∏Ïπº": "011170.KS",
            # Í∏àÏúµ ÎåÄÌòïÏ£º
            "KBÍ∏àÏúµ": "105560.KS", "Ïã†ÌïúÏßÄÏ£º": "055550.KS", "ÌïòÎÇòÍ∏àÏúµÏßÄÏ£º": "086790.KS",
            "Ïö∞Î¶¨Í∏àÏúµÏßÄÏ£º": "316140.KS", "ÏÇºÏÑ±ÏÉùÎ™Ö": "032830.KS", "ÏÇºÏÑ±ÌôîÏû¨": "000810.KS",
            # Í±¥ÏÑ§/Ï§ëÍ≥µÏóÖ ÎåÄÌòïÏ£º
            "ÏÇºÏÑ±Î¨ºÏÇ∞": "028260.KS", "ÌòÑÎåÄÍ±¥ÏÑ§": "000720.KS", "HDÌòÑÎåÄ": "267250.KS",
            # Ïú†ÌÜµ/ÏÑúÎπÑÏä§ ÎåÄÌòïÏ£º
            "Ïã†ÏÑ∏Í≥Ñ": "004170.KS", "Î°ØÎç∞ÏáºÌïë": "023530.KS", "CJÏ†úÏùºÏ†úÎãπ": "097950.KS",
        }
    
    new_high_stocks = []
    
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    total = len(kospi_symbols)
    processed = 0
    errors = 0
    
    # 1Îã®Í≥Ñ: 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™©Îßå Îπ†Î•¥Í≤å ÌïÑÌÑ∞ÎßÅ (ÏßÄÌëú Í≥ÑÏÇ∞ ÏóÜÏù¥)
    for idx, (name, symbol) in enumerate(kospi_symbols.items()):
        try:
            status_text.text(f"Í≤ÄÏÉâ Ï§ë: {name} ({idx+1}/{total}) | 20Ïùº Ïã†Í≥†Í∞Ä: {len(new_high_stocks)}Í∞ú | Ïò§Î•ò: {errors}Í∞ú")
            progress_bar.progress((idx + 1) / total)
            
            # ÏµúÏÜåÌïúÏùò Îç∞Ïù¥ÌÑ∞Îßå Î°úÎìú (1Í∞úÏõî)
            data = load_data(symbol, period="1mo")
            if data is None or data.empty or len(data) < 20:
                errors += 1
                continue
            
            latest = data.iloc[-1]
            
            # 20Ïùº Ïã†Í≥†Í∞Ä Ï≤¥ÌÅ¨ (ÏßÄÌëú Í≥ÑÏÇ∞ ÏóÜÏù¥ Îã®Ïàú ÎπÑÍµêÎßå)
            high_20d = data['High'][-20:].max()
            is_new_high = latest['Close'] >= high_20d * 0.99  # 99% Ïù¥ÏÉÅÏù¥Î©¥ Ïã†Í≥†Í∞Ä Í∑ºÏ≤ò
            
            if is_new_high:
                # Ïã†Í≥†Í∞Ä Ï¢ÖÎ™© Î∞úÍ≤¨ Ïãú 3Í∞úÏõî Îç∞Ïù¥ÌÑ∞Î°ú ÏßÄÌëú Í≥ÑÏÇ∞
                data_3m = load_data(symbol, period="3mo")
                if data_3m is not None and not data_3m.empty:
                    data_with_indicators = calculate_indicators(data_3m)
                    latest_with_indicators = data_with_indicators.iloc[-1]
                    new_high_stocks.append((name, symbol, data_with_indicators, latest_with_indicators))
            
            processed += 1
        
        except Exception as e:
            errors += 1
            continue
    
    progress_bar.empty()
    status_text.empty()
    
    # Îì±ÎùΩÎ•† ÎÜíÏùÄ ÏàúÏúºÎ°ú Ï†ïÎ†¨ (Î™®Î©òÌÖÄ Í∞ïÌïú Ï¢ÖÎ™© Ïö∞ÏÑ†)
    new_high_stocks.sort(key=lambda x: ((x[3]['Close'] - x[2].iloc[-2]['Close']) / x[2].iloc[-2]['Close']) * 100, reverse=True)
    
    st.success(f"‚úÖ Î∂ÑÏÑù ÏôÑÎ£å: Ï¥ù {processed}Í∞ú Ï¢ÖÎ™© Ï≤òÎ¶¨, {len(new_high_stocks)}Í∞ú Ï¢ÖÎ™©Ïù¥ 20Ïùº Ïã†Í≥†Í∞Ä Îã¨ÏÑ±")
    
    return new_high_stocks

def display_metrics(data, name):
    """
    Ï£ºÏöî ÏßÄÌëú ÌëúÏãú
    """
    latest = data.iloc[-1]
    previous = data.iloc[-2]
    
    current_price = latest['Close']
    price_change = current_price - previous['Close']
    price_change_pct = (price_change / previous['Close']) * 100
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric(
            label="ÌòÑÏû¨Í∞Ä",
            value=f"{current_price:,.2f}",
            delta=f"{price_change_pct:+.2f}%"
        )
    
    with col2:
        rsi_value = latest['RSI']
        rsi_status = "Í≥ºÎß§Ïàò" if rsi_value > 70 else "Í≥ºÎß§ÎèÑ" if rsi_value < 30 else "Ï§ëÎ¶Ω"
        st.metric(
            label=f"RSI ({rsi_status})",
            value=f"{rsi_value:.2f}"
        )

# ==================== Î©îÏù∏ Ïï± ====================

# ÏÇ¨Ïù¥ÎìúÎ∞î ÏÑ§Ï†ï
with st.sidebar:
    st.header("‚öôÔ∏è ÏÑ§Ï†ï")
    
    # Î∑∞ Î™®Îìú ÏÑ†ÌÉù
    view_mode = st.radio(
        "Î≥¥Í∏∞ Î™®Îìú",
        ["üìä Ï†ÑÏ≤¥ Í∞úÏöî", "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù"],
        index=0
    )
    
    if view_mode == "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù":
        # Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
        selected_category = st.selectbox(
            "ÏûêÏÇ∞ Ïπ¥ÌÖåÍ≥†Î¶¨",
            list(ASSETS.keys())
        )
        
        # ÏûêÏÇ∞ ÏÑ†ÌÉù
        selected_asset = st.selectbox(
            "ÏûêÏÇ∞ ÏÑ†ÌÉù",
            list(ASSETS[selected_category].keys())
        )
    
    # Í∏∞Í∞Ñ ÏÑ†ÌÉù
    period_options = {
        "1Í∞úÏõî": "1mo",
        "3Í∞úÏõî": "3mo",
        "6Í∞úÏõî": "6mo",
        "1ÎÖÑ": "1y",
        "2ÎÖÑ": "2y",
        "5ÎÖÑ": "5y"
    }
    selected_period = st.selectbox(
        "Ï°∞Ìöå Í∏∞Í∞Ñ",
        list(period_options.keys()),
        index=3
    )
    
    st.markdown("---")
    st.markdown("### ‚öôÔ∏è Î≥¥Ï°∞ÏßÄÌëú ÏÑ§Ï†ï")
    
    with st.expander("üìä ÏßÄÌëú ÏÑ§Ï†ïÍ∞í Î≥¥Í∏∞", expanded=False):
        st.markdown("""
        **Ïù¥ÎèôÌèâÍ∑†ÏÑ† (MA)**
        - MA20: 20Ïùº
        - MA50: 50Ïùº
        - MA200: 200Ïùº
        
        **Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú (BB)**
        - Í∏∞Í∞Ñ: 18
        - ÏäπÏàò: 2.00
        
        **RSI**
        - Í∏∞Í∞Ñ: 14
        - Signal: 6
        
        **Stochastic Slow**
        - Í∏∞Í∞Ñ: 10
        - %K: 6
        - %D: 6
        
        **MACD**
        - Îã®Í∏∞: 12
        - Ïû•Í∏∞: 26
        - Signal: 9
        
        **ÏùºÎ™©Í∑†ÌòïÌëú**
        - Ï†ÑÌôòÏÑ†: 9Ïùº
        - Í∏∞Ï§ÄÏÑ†: 26Ïùº
        - ÏÑ†ÌñâÏä§Ìå¨: 52Ïùº
        - ÌõÑÌñâÏä§Ìå¨: 26Ïùº
        """)

# ==================== Ï†ÑÏ≤¥ Í∞úÏöî Î™®Îìú ====================
if view_mode == "üìä Ï†ÑÏ≤¥ Í∞úÏöî":
    
    # Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
    for category_name, category_assets in ASSETS.items():
        st.subheader(f"üìå {category_name}")
        
        # Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïª¨Îüº Ïàò Í≤∞Ï†ï
        num_cols = min(4, len(category_assets))
        cols = st.columns(num_cols)
        
        for idx, (asset_name, ticker) in enumerate(category_assets.items()):
            with cols[idx % num_cols]:
                with st.spinner(f'{asset_name} Î°úÎî©...'):
                    data = load_data(ticker, period=period_options[selected_period])
                    
                    if data is not None and not data.empty:
                        latest = data.iloc[-1]
                        previous = data.iloc[-2]
                        
                        current_price = latest['Close']
                        price_change = current_price - previous['Close']
                        price_change_pct = (price_change / previous['Close']) * 100
                        
                        # Ïπ¥Îìú ÌòïÌÉúÎ°ú ÌëúÏãú
                        st.markdown(f"### {asset_name}")
                        st.metric(
                            label="ÌòÑÏû¨Í∞Ä",
                            value=f"{current_price:,.2f}",
                            delta=f"{price_change_pct:+.2f}%"
                        )
                        
                        # Í∞ÑÎã®Ìïú Ï∞®Ìä∏
                        data_with_indicators = calculate_indicators(data)
                        
                        # ÎØ∏Îãà Ï∞®Ìä∏ ÏÉùÏÑ±
                        mini_fig = go.Figure()
                        mini_fig.add_trace(go.Candlestick(
                            x=data.index[-60:],  # ÏµúÍ∑º 60Ïùº (ÌõÑÌñâÏä§Ìå¨ ÌëúÏãú ÏúÑÌï¥)
                            open=data['Open'][-60:],
                            high=data['High'][-60:],
                            low=data['Low'][-60:],
                            close=data['Close'][-60:],
                            increasing_line_color='red',
                            decreasing_line_color='blue',
                            increasing_fillcolor='red',
                            decreasing_fillcolor='blue',
                            showlegend=False,
                            name='Í∞ÄÍ≤©'
                        ))
                        
                        # Ïù¥ÎèôÌèâÍ∑†ÏÑ† Ï∂îÍ∞Ä
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['MA20'][-60:],
                            name='MA20',
                            line=dict(color='orange', width=1)
                        ))
                        
                        # Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Ï∂îÍ∞Ä
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['BB_Upper'][-60:],
                            name='BBÏÉÅÎã®',
                            line=dict(color='gray', width=1, dash='dash'),
                            showlegend=False
                        ))
                        
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['BB_Lower'][-60:],
                            name='BBÌïòÎã®',
                            line=dict(color='gray', width=1, dash='dash'),
                            fill='tonexty',
                            fillcolor='rgba(128, 128, 128, 0.1)',
                            showlegend=False
                        ))
                        
                        # ÌõÑÌñâÏä§Ìå¨ Ï∂îÍ∞Ä (Ï£ºÌô©ÏÉâ Ï†êÏÑ†)
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['Ichimoku_Lagging'][-60:],
                            name='ÌõÑÌñâÏä§Ìå¨',
                            line=dict(color='orange', width=2, dash='dot')
                        ))
                        
                        mini_fig.update_layout(
                            height=250,
                            margin=dict(l=0, r=0, t=0, b=0),
                            xaxis_rangeslider_visible=False,
                            showlegend=True,
                            legend=dict(
                                orientation="h",
                                yanchor="bottom",
                                y=1.02,
                                xanchor="right",
                                x=1,
                                font=dict(size=8)
                            ),
                            xaxis=dict(showticklabels=False),
                            yaxis=dict(side='right')
                        )
                        
                        st.plotly_chart(mini_fig, use_container_width=True)
                        
                        # Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏöîÏïΩ
                        with st.expander("üìä Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏöîÏïΩ"):
                            latest_ind = data_with_indicators.iloc[-1]
                            
                            # Î≥ºÎ¶∞Ï†ÄÎ∞¥ÎìúÏôÄ ÌõÑÌñâÏä§Ìå¨ Î∂ÑÏÑù
                            lagging_span = latest_ind['Ichimoku_Lagging']
                            bb_upper = latest_ind['BB_Upper']
                            bb_lower = latest_ind['BB_Lower']
                            
                            # ÌõÑÌñâÏä§Ìå¨Í≥º Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Í¥ÄÍ≥Ñ
                            if pd.notna(lagging_span):
                                if lagging_span > bb_upper:
                                    st.write("üî¥ ÌõÑÌñâÏä§Ìå¨ > BBÏÉÅÎã® (Í≥ºÎß§Ïàò)")
                                elif lagging_span < bb_lower:
                                    st.write("üü¢ ÌõÑÌñâÏä§Ìå¨ < BBÌïòÎã® (Í≥ºÎß§ÎèÑ)")
                                elif lagging_span > current_price:
                                    st.write("üü¢ ÌõÑÌñâÏä§Ìå¨ > ÌòÑÏû¨Í∞Ä (Í∞ïÏÑ∏)")
                                elif lagging_span < current_price:
                                    st.write("üî¥ ÌõÑÌñâÏä§Ìå¨ < ÌòÑÏû¨Í∞Ä (ÏïΩÏÑ∏)")
                                else:
                                    st.write("üü° ÌõÑÌñâÏä§Ìå¨ = ÌòÑÏû¨Í∞Ä")
                            
                            st.markdown("---")
                            
                            # RSI
                            rsi = latest_ind['RSI']
                            if rsi > 70:
                                st.write("üî¥ RSI: Í≥ºÎß§Ïàò")
                            elif rsi < 30:
                                st.write("üü¢ RSI: Í≥ºÎß§ÎèÑ")
                            else:
                                st.write(f"üü° RSI: {rsi:.1f}")
                            
                            # MACD
                            if latest_ind['MACD'] > latest_ind['MACD_Signal']:
                                st.write("üü¢ MACD: ÏÉÅÏäπ")
                            else:
                                st.write("üî¥ MACD: ÌïòÎùΩ")
                            
                            # Ïù¥ÎèôÌèâÍ∑†
                            if current_price > latest_ind['MA20']:
                                st.write("‚úÖ MA20 ÏúÑ")
                            else:
                                st.write("‚ùå MA20 ÏïÑÎûò")
                    else:
                        st.error(f"‚ùå {asset_name} Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®")
        
        st.markdown("---")

# ==================== ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îìú ====================
elif view_mode == "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù":
    # Ìã∞Ïª§ Í∞ÄÏ†∏Ïò§Í∏∞
    ticker = ASSETS[selected_category][selected_asset]

    # Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    with st.spinner(f'{selected_asset} Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...'):
        data = load_data(ticker, period=period_options[selected_period])

    if data is not None and not data.empty:
        # ÏßÄÌëú Í≥ÑÏÇ∞
        data_with_indicators = calculate_indicators(data)
        
        # Ï£ºÏöî ÏßÄÌëú ÌëúÏãú
        st.subheader(f"üìä {selected_asset} ÌòÑÌô©")
        display_metrics(data_with_indicators, selected_asset)
        
        st.markdown("---")
        
        # Í∞ÑÎã®Ìïú Í∞ÄÍ≤© Ï∞®Ìä∏Îßå ÌëúÏãú
        st.subheader(f"üìà {selected_asset} Í∞ÄÍ≤© Ï∞®Ìä∏")
        simple_chart = create_simple_chart(data_with_indicators, selected_asset)
        st.plotly_chart(simple_chart, use_container_width=True)
        
        # KOSPI ÏÑ†ÌÉù Ïãú Ï¢ÖÎ™© Ïä§ÌÅ¨Î¶¨Îãù Í≤∞Í≥º ÌëúÏãú
        if selected_asset == "üá∞üá∑ KOSPI":
            st.markdown("---")
            st.subheader("üîç KOSPI Ïö∞ÎüâÍ∏∞ÏóÖ Ïä§ÌÅ¨Î¶¨Îãù")
            
            with st.spinner("KOSPI 200 Ïö∞ÎüâÍ∏∞ÏóÖÏóêÏÑú 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™© Í≤ÄÏÉâ Ï§ë... (ÏïΩ 1Î∂Ñ ÏÜåÏöî)"):
                new_high_stocks = screen_kospi_stocks()
            
            # 20Ïùº Ïã†Í≥†Í∞Ä Ï¢ÖÎ™© ÌëúÏãú
            st.info("üìä ÎåÄÏÉÅ: KOSPI 200 Ïö∞ÎüâÍ∏∞ÏóÖ (ÏãúÍ∞ÄÏ¥ùÏï° ÏÉÅÏúÑ 200Í∞ú) | Ï°∞Í±¥: 20Ïùº Ïã†Í≥†Í∞Ä")
            
            if new_high_stocks:
                st.success(f"‚úÖ {len(new_high_stocks)}Í∞ú Ï¢ÖÎ™©Ïù¥ 20Ïùº Ïã†Í≥†Í∞ÄÎ•º Îã¨ÏÑ±ÌñàÏäµÎãàÎã§!")
                
                # 3Ïó¥Î°ú ÌëúÏãú
                num_cols = 3
                for i in range(0, len(new_high_stocks), num_cols):
                    cols = st.columns(num_cols)
                    for j in range(num_cols):
                        idx = i + j
                        if idx < len(new_high_stocks):
                            name, symbol, stock_data, latest_data = new_high_stocks[idx]
                            
                            with cols[j]:
                                st.markdown(f"### {name}")
                                
                                # ÌòÑÏû¨Í∞Ä Î∞è Îì±ÎùΩÎ•†
                                if len(stock_data) >= 2:
                                    prev = stock_data.iloc[-2]
                                    change_pct = ((latest_data['Close'] - prev['Close']) / prev['Close']) * 100
                                    st.metric("ÌòÑÏû¨Í∞Ä", f"{latest_data['Close']:,.0f}Ïõê", f"{change_pct:+.2f}%")
                                else:
                                    st.metric("ÌòÑÏû¨Í∞Ä", f"{latest_data['Close']:,.0f}Ïõê")
                                
                                # Í∏∞Ïà†Ï†Å ÏßÄÌëú ÌëúÏãú
                                col1, col2, col3 = st.columns(3)
                                with col1:
                                    rsi = latest_data['RSI']
                                    if pd.notna(rsi):
                                        st.metric("RSI", f"{rsi:.1f}")
                                with col2:
                                    # ÌõÑÌñâÏä§Ìå¨Í≥º BBÏÉÅÎã® ÎπÑÍµê
                                    if pd.notna(latest_data['Ichimoku_Lagging']) and pd.notna(latest_data['BB_Upper']):
                                        lagging = latest_data['Ichimoku_Lagging']
                                        bb_upper = latest_data['BB_Upper']
                                        breakthrough = "‚úÖ" if lagging > bb_upper else "‚ùå"
                                        st.metric("ÌõÑÌñâ>BB", breakthrough)
                                with col3:
                                    # 20Ïùº Ïã†Í≥†Í∞Ä Îã¨ÏÑ±Î•†
                                    high_20d = stock_data['High'][-20:].max()
                                    achievement = (latest_data['Close'] / high_20d) * 100
                                    st.metric("Ïã†Í≥†Í∞Ä", f"{achievement:.1f}%")
                                
                                # ÏÉÅÏÑ∏ Ï∞®Ìä∏ (ÌõÑÌñâÏä§Ìå¨, Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Ìè¨Ìï®)
                                chart = create_simple_chart(stock_data, name)
                                st.plotly_chart(chart, use_container_width=True)
                                
                                st.markdown("---")
            else:
                st.warning("‚ö†Ô∏è ÌòÑÏû¨ 20Ïùº Ïã†Í≥†Í∞ÄÎ•º Îã¨ÏÑ±Ìïú Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.")
                st.info("üí° ÌåÅ: ÏãúÏû• Ï°∞Ï†ï ÏãúÍ∏∞ÏóêÎäî Ïã†Í≥†Í∞Ä Ï¢ÖÎ™©Ïù¥ Ï†ÅÏùÑ Ïàò ÏûàÏäµÎãàÎã§.")


    else:
        st.error(f"‚ùå {selected_asset} Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ ÏûêÏÇ∞ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")

# Ìë∏ÌÑ∞
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: gray; padding: 20px;'>
    <p>üìä Îç∞Ïù¥ÌÑ∞ Ï∂úÏ≤ò: Yahoo Finance | ‚ö†Ô∏è Ìà¨Ïûê Í≤∞Ï†ïÏùÄ Î≥∏Ïù∏Ïùò Ï±ÖÏûÑÏûÖÎãàÎã§.</p>
    <p>Ïù¥ ÎåÄÏãúÎ≥¥ÎìúÎäî Ï†ïÎ≥¥ Ï†úÍ≥µ Î™©Ï†ÅÏù¥Î©∞, Ìà¨Ïûê Ï°∞Ïñ∏Ïù¥ ÏïÑÎãôÎãàÎã§.</p>
</div>
""", unsafe_allow_html=True)
