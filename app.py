import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import ta
import ssl
import certifi

# SSL Ïù∏Ï¶ùÏÑú Î¨∏Ï†ú Ìï¥Í≤∞
ssl._create_default_https_context = ssl._create_unverified_context

# ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï
st.set_page_config(
    page_title="Í∏ÄÎ°úÎ≤å Ìà¨Ïûê ÎåÄÏãúÎ≥¥Îìú",
    page_icon="üìà",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ÏûêÏÇ∞ Ï†ïÏùò
ASSETS = {
    "Ï£ºÍ∞ÄÏßÄÏàò": {
        "üá∞üá∑ KOSPI": "^KS11",
        "üá∫üá∏ S&P 500": "^GSPC",
        "üá∫üá∏ ÎÇòÏä§Îã•": "^IXIC",
        "üá∫üá∏ Îã§Ïö∞Ï°¥Ïä§": "^DJI",
        "üá®üá≥ ÏÉÅÌï¥Ï¢ÖÌï©": "000001.SS",
        "üáØüáµ ÎãõÏºÄÏù¥225": "^N225",
        "üá©üá™ DAX": "^GDAXI",
        "üá¨üáß FTSE 100": "^FTSE",
    },
    "Ï±ÑÍ∂å": {
        "ÎØ∏Íµ≠ 10ÎÖÑ Íµ≠Ï±Ñ": "^TNX",
        "ÎØ∏Íµ≠ 2ÎÖÑ Íµ≠Ï±Ñ": "^IRX",
        "ÎØ∏Íµ≠ 30ÎÖÑ Íµ≠Ï±Ñ": "^TYX",
    },
    "ÏÉÅÌíà": {
        "Í∏à (Gold)": "GC=F",
        "ÏùÄ (Silver)": "SI=F",
        "WTI ÏõêÏú†": "CL=F",
        "Ï≤úÏó∞Í∞ÄÏä§": "NG=F",
        "Íµ¨Î¶¨": "HG=F",
    },
    "ÏïîÌò∏ÌôîÌèê": {
        "ÎπÑÌä∏ÏΩîÏù∏": "BTC-USD",
        "Ïù¥ÎçîÎ¶¨ÏõÄ": "ETH-USD",
    }
}

# Ï∫êÏãúÎ•º ÏÇ¨Ïö©Ìïú Îç∞Ïù¥ÌÑ∞ Î°úÎî©
@st.cache_data(ttl=300)  # 5Î∂Ñ Ï∫êÏãú
def load_data(ticker, period="1y"):
    """
    Ìã∞Ïª§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    """
    try:
        # SSL Í≤ÄÏ¶ù ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú
        data = yf.download(ticker, period=period, progress=False)
        if data.empty:
            return None
        
        # Multi-level columnsÏùÑ flatÌïòÍ≤å Î≥ÄÌôò
        if isinstance(data.columns, pd.MultiIndex):
            data.columns = data.columns.get_level_values(0)
        
        return data
    except Exception as e:
        st.error(f"Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: {ticker} - {str(e)}")
        return None

def calculate_indicators(data):
    """
    Í∏∞Ïà†Ï†Å ÏßÄÌëú Í≥ÑÏÇ∞
    """
    df = data.copy()
    
    # Close Ïª¨ÎüºÏù¥ SeriesÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† Î≥ÄÌôò
    close_series = df['Close'].squeeze() if hasattr(df['Close'], 'squeeze') else df['Close']
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ†
    df['MA20'] = close_series.rolling(window=20).mean()
    df['MA50'] = close_series.rolling(window=50).mean()
    df['MA200'] = close_series.rolling(window=200).mean()
    
    # RSI (Í∏∞Í∞Ñ 14, Signal 6)
    rsi_indicator = ta.momentum.RSIIndicator(close_series, window=14)
    df['RSI'] = rsi_indicator.rsi()
    df['RSI_Signal'] = df['RSI'].rolling(window=6).mean()
    
    # MACD (Îã®Í∏∞12, Ïû•Í∏∞26, Signal 9)
    macd = ta.trend.MACD(close_series, window_slow=26, window_fast=12, window_sign=9)
    df['MACD'] = macd.macd()
    df['MACD_Signal'] = macd.macd_signal()
    df['MACD_Hist'] = macd.macd_diff()
    
    # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú (Í∏∞Í∞Ñ 18, ÏäπÏàò 2.0)
    bollinger = ta.volatility.BollingerBands(close_series, window=18, window_dev=2.0)
    df['BB_Upper'] = bollinger.bollinger_hband()
    df['BB_Middle'] = bollinger.bollinger_mavg()
    df['BB_Lower'] = bollinger.bollinger_lband()
    
    # Ïä§ÌÜ†Ï∫êÏä§Ìã± Ïä¨Î°úÏö∞ (Í∏∞Í∞Ñ 10, %K 6, %D 6)
    stoch = ta.momentum.StochasticOscillator(
        high=df['High'].squeeze() if hasattr(df['High'], 'squeeze') else df['High'],
        low=df['Low'].squeeze() if hasattr(df['Low'], 'squeeze') else df['Low'],
        close=close_series,
        window=10,
        smooth_window=6
    )
    df['Stoch_K'] = stoch.stoch()
    df['Stoch_D'] = stoch.stoch_signal()
    
    # ÏùºÎ™©Í∑†ÌòïÌëú (Ichimoku)
    ichimoku = ta.trend.IchimokuIndicator(
        high=df['High'].squeeze() if hasattr(df['High'], 'squeeze') else df['High'],
        low=df['Low'].squeeze() if hasattr(df['Low'], 'squeeze') else df['Low']
    )
    df['Ichimoku_Conversion'] = ichimoku.ichimoku_conversion_line()  # Ï†ÑÌôòÏÑ† (9Ïùº)
    df['Ichimoku_Base'] = ichimoku.ichimoku_base_line()  # Í∏∞Ï§ÄÏÑ† (26Ïùº)
    df['Ichimoku_A'] = ichimoku.ichimoku_a()  # ÏÑ†ÌñâÏä§Ìå¨A
    df['Ichimoku_B'] = ichimoku.ichimoku_b()  # ÏÑ†ÌñâÏä§Ìå¨B
    
    # ÌõÑÌñâÏä§Ìå¨ Í≥ÑÏÇ∞ (ÎãπÏùº Ï¢ÖÍ∞ÄÎ•º 26Ïùº Ï†ÑÏóê ÌëúÏãú)
    df['Ichimoku_Lagging'] = close_series.shift(-26)
    
    return df

def create_chart(data, title):
    """
    PlotlyÎ•º ÏÇ¨Ïö©Ìïú Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Ï∞®Ìä∏ ÏÉùÏÑ±
    """
    # ÏÑúÎ∏åÌîåÎ°Ø ÏÉùÏÑ±: Í∞ÄÍ≤©, Í±∞ÎûòÎüâ, RSI, Stochastic, MACD
    fig = make_subplots(
        rows=5, cols=1,
        shared_xaxes=True,
        vertical_spacing=0.02,
        subplot_titles=(f'{title} Í∞ÄÍ≤©', 'Í±∞ÎûòÎüâ', 'RSI', 'Stochastic Slow', 'MACD'),
        row_heights=[0.4, 0.15, 0.15, 0.15, 0.15]
    )
    
    # Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏ (ÏÉÅÏäπ: Îπ®Í∞ï, ÌïòÎùΩ: ÌååÎûë)
    fig.add_trace(
        go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name='Í∞ÄÍ≤©',
            increasing_line_color='red',
            decreasing_line_color='blue',
            increasing_fillcolor='red',
            decreasing_fillcolor='blue'
        ),
        row=1, col=1
    )
    
    # Ïù¥ÎèôÌèâÍ∑†ÏÑ†
    fig.add_trace(go.Scatter(x=data.index, y=data['MA20'], name='MA20', line=dict(color='orange', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MA50'], name='MA50', line=dict(color='blue', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MA200'], name='MA200', line=dict(color='red', width=1)), row=1, col=1)
    
    # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Upper'], name='BB Upper', line=dict(color='gray', width=1, dash='dash')), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['BB_Lower'], name='BB Lower', line=dict(color='gray', width=1, dash='dash')), row=1, col=1)
    
    # ÏùºÎ™©Í∑†ÌòïÌëú
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Conversion'], name='Ï†ÑÌôòÏÑ†(9)', line=dict(color='cyan', width=1)), row=1, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Base'], name='Í∏∞Ï§ÄÏÑ†(26)', line=dict(color='magenta', width=1)), row=1, col=1)
    
    # ÌõÑÌñâÏä§Ìå¨ (26Ïùº Îí§Î°ú Ïù¥Îèô)
    fig.add_trace(go.Scatter(x=data.index, y=data['Ichimoku_Lagging'], name='ÌõÑÌñâÏä§Ìå¨(26)', line=dict(color='orange', width=1, dash='dot')), row=1, col=1)
    
    # ÏùºÎ™©Í∑†ÌòïÌëú Íµ¨Î¶ÑÎåÄ - ÏñëÏö¥(Îπ®Í∞ï)Í≥º ÏùåÏö¥(ÌååÎûë) Íµ¨Î∂Ñ
    # ÏÑ†ÌñâÏä§Ìå¨AÏôÄ BÎ•º ÎπÑÍµêÌïòÏó¨ ÏÉâÏÉÅ Í≤∞Ï†ï
    for i in range(len(data)):
        if i == 0:
            continue
        
        span_a_curr = data['Ichimoku_A'].iloc[i]
        span_b_curr = data['Ichimoku_B'].iloc[i]
        span_a_prev = data['Ichimoku_A'].iloc[i-1]
        span_b_prev = data['Ichimoku_B'].iloc[i-1]
        
        # ÏñëÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A > ÏÑ†ÌñâÏä§Ìå¨B): Îπ®Í∞ÑÏÉâ
        if span_a_curr >= span_b_curr:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(255, 0, 0, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
        # ÏùåÏö¥ (ÏÑ†ÌñâÏä§Ìå¨A < ÏÑ†ÌñâÏä§Ìå¨B): ÌååÎûÄÏÉâ
        else:
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_a_prev, span_a_curr],
                fill=None,
                mode='lines',
                line=dict(width=0),
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
            
            fig.add_trace(go.Scatter(
                x=[data.index[i-1], data.index[i]],
                y=[span_b_prev, span_b_curr],
                fill='tonexty',
                mode='lines',
                line=dict(width=0),
                fillcolor='rgba(0, 0, 255, 0.2)',
                showlegend=False,
                hoverinfo='skip'
            ), row=1, col=1)
    
    # ÏÑ†ÌñâÏä§Ìå¨ ÎùºÏù∏ ÌëúÏãú
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_A'], 
        name='ÏÑ†ÌñâÏä§Ìå¨A', 
        line=dict(color='green', width=1),
        showlegend=True
    ), row=1, col=1)
    
    fig.add_trace(go.Scatter(
        x=data.index, 
        y=data['Ichimoku_B'], 
        name='ÏÑ†ÌñâÏä§Ìå¨B', 
        line=dict(color='red', width=1),
        showlegend=True
    ), row=1, col=1)
    
    # Í±∞ÎûòÎüâ (ÏÉÅÏäπ: Îπ®Í∞ï, ÌïòÎùΩ: ÌååÎûë)
    colors = ['red' if close >= open_ else 'blue' for close, open_ in zip(data['Close'], data['Open'])]
    fig.add_trace(
        go.Bar(x=data.index, y=data['Volume'], name='Í±∞ÎûòÎüâ', marker_color=colors),
        row=2, col=1
    )
    
    # RSI
    fig.add_trace(go.Scatter(x=data.index, y=data['RSI'], name='RSI', line=dict(color='purple', width=2)), row=3, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['RSI_Signal'], name='RSI Signal', line=dict(color='orange', width=1.5)), row=3, col=1)
    fig.add_hline(y=70, line_dash="dash", line_color="red", row=3, col=1)
    fig.add_hline(y=30, line_dash="dash", line_color="green", row=3, col=1)
    
    # Stochastic Slow
    fig.add_trace(go.Scatter(x=data.index, y=data['Stoch_K'], name='%K (6)', line=dict(color='blue', width=2)), row=4, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['Stoch_D'], name='%D (6)', line=dict(color='red', width=2)), row=4, col=1)
    fig.add_hline(y=80, line_dash="dash", line_color="red", row=4, col=1)
    fig.add_hline(y=20, line_dash="dash", line_color="green", row=4, col=1)
    
    # MACD
    fig.add_trace(go.Scatter(x=data.index, y=data['MACD'], name='MACD', line=dict(color='blue', width=2)), row=5, col=1)
    fig.add_trace(go.Scatter(x=data.index, y=data['MACD_Signal'], name='Signal', line=dict(color='red', width=2)), row=5, col=1)
    fig.add_trace(go.Bar(x=data.index, y=data['MACD_Hist'], name='Histogram', marker_color='gray'), row=5, col=1)
    
    # Î†àÏù¥ÏïÑÏõÉ ÏóÖÎç∞Ïù¥Ìä∏
    fig.update_layout(
        height=1200,
        showlegend=True,
        xaxis_rangeslider_visible=False,
        hovermode='x unified'
    )
    
    fig.update_xaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    fig.update_yaxes(showgrid=True, gridwidth=1, gridcolor='LightGray')
    
    return fig

def display_metrics(data, name):
    """
    Ï£ºÏöî ÏßÄÌëú ÌëúÏãú
    """
    latest = data.iloc[-1]
    previous = data.iloc[-2]
    
    current_price = latest['Close']
    price_change = current_price - previous['Close']
    price_change_pct = (price_change / previous['Close']) * 100
    
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric(
            label="ÌòÑÏû¨Í∞Ä",
            value=f"{current_price:,.2f}",
            delta=f"{price_change_pct:+.2f}%"
        )
    
    with col2:
        st.metric(
            label="Í±∞ÎûòÎüâ",
            value=f"{latest['Volume']:,.0f}"
        )
    
    with col3:
        rsi_value = latest['RSI']
        rsi_status = "Í≥ºÎß§Ïàò" if rsi_value > 70 else "Í≥ºÎß§ÎèÑ" if rsi_value < 30 else "Ï§ëÎ¶Ω"
        st.metric(
            label=f"RSI ({rsi_status})",
            value=f"{rsi_value:.2f}"
        )
    
    with col4:
        st.metric(
            label="52Ï£º ÏµúÍ≥†",
            value=f"{data['High'].tail(252).max():,.2f}"
        )
    
    with col5:
        st.metric(
            label="52Ï£º ÏµúÏ†Ä",
            value=f"{data['Low'].tail(252).min():,.2f}"
        )

# ==================== Î©îÏù∏ Ïï± ====================

# ÏÇ¨Ïù¥ÎìúÎ∞î ÏÑ§Ï†ï
with st.sidebar:
    st.header("‚öôÔ∏è ÏÑ§Ï†ï")
    
    # Î∑∞ Î™®Îìú ÏÑ†ÌÉù
    view_mode = st.radio(
        "Î≥¥Í∏∞ Î™®Îìú",
        ["üìä Ï†ÑÏ≤¥ Í∞úÏöî", "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù"],
        index=0
    )
    
    if view_mode == "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù":
        # Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
        selected_category = st.selectbox(
            "ÏûêÏÇ∞ Ïπ¥ÌÖåÍ≥†Î¶¨",
            list(ASSETS.keys())
        )
        
        # ÏûêÏÇ∞ ÏÑ†ÌÉù
        selected_asset = st.selectbox(
            "ÏûêÏÇ∞ ÏÑ†ÌÉù",
            list(ASSETS[selected_category].keys())
        )
    
    # Í∏∞Í∞Ñ ÏÑ†ÌÉù
    period_options = {
        "1Í∞úÏõî": "1mo",
        "3Í∞úÏõî": "3mo",
        "6Í∞úÏõî": "6mo",
        "1ÎÖÑ": "1y",
        "2ÎÖÑ": "2y",
        "5ÎÖÑ": "5y"
    }
    selected_period = st.selectbox(
        "Ï°∞Ìöå Í∏∞Í∞Ñ",
        list(period_options.keys()),
        index=3
    )
    
    st.markdown("---")
    st.markdown("### ‚öôÔ∏è Î≥¥Ï°∞ÏßÄÌëú ÏÑ§Ï†ï")
    
    with st.expander("üìä ÏßÄÌëú ÏÑ§Ï†ïÍ∞í Î≥¥Í∏∞", expanded=False):
        st.markdown("""
        **Ïù¥ÎèôÌèâÍ∑†ÏÑ† (MA)**
        - MA20: 20Ïùº
        - MA50: 50Ïùº
        - MA200: 200Ïùº
        
        **Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú (BB)**
        - Í∏∞Í∞Ñ: 18
        - ÏäπÏàò: 2.00
        
        **RSI**
        - Í∏∞Í∞Ñ: 14
        - Signal: 6
        
        **Stochastic Slow**
        - Í∏∞Í∞Ñ: 10
        - %K: 6
        - %D: 6
        
        **MACD**
        - Îã®Í∏∞: 12
        - Ïû•Í∏∞: 26
        - Signal: 9
        
        **ÏùºÎ™©Í∑†ÌòïÌëú**
        - Ï†ÑÌôòÏÑ†: 9Ïùº
        - Í∏∞Ï§ÄÏÑ†: 26Ïùº
        - ÏÑ†ÌñâÏä§Ìå¨: 52Ïùº
        - ÌõÑÌñâÏä§Ìå¨: 26Ïùº
        """)

# ==================== Ï†ÑÏ≤¥ Í∞úÏöî Î™®Îìú ====================
if view_mode == "üìä Ï†ÑÏ≤¥ Í∞úÏöî":
    
    # Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
    for category_name, category_assets in ASSETS.items():
        st.subheader(f"üìå {category_name}")
        
        # Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïª¨Îüº Ïàò Í≤∞Ï†ï
        num_cols = min(4, len(category_assets))
        cols = st.columns(num_cols)
        
        for idx, (asset_name, ticker) in enumerate(category_assets.items()):
            with cols[idx % num_cols]:
                with st.spinner(f'{asset_name} Î°úÎî©...'):
                    data = load_data(ticker, period=period_options[selected_period])
                    
                    if data is not None and not data.empty:
                        latest = data.iloc[-1]
                        previous = data.iloc[-2]
                        
                        current_price = latest['Close']
                        price_change = current_price - previous['Close']
                        price_change_pct = (price_change / previous['Close']) * 100
                        
                        # Ïπ¥Îìú ÌòïÌÉúÎ°ú ÌëúÏãú
                        st.markdown(f"### {asset_name}")
                        st.metric(
                            label="ÌòÑÏû¨Í∞Ä",
                            value=f"{current_price:,.2f}",
                            delta=f"{price_change_pct:+.2f}%"
                        )
                        
                        # Í∞ÑÎã®Ìïú Ï∞®Ìä∏
                        data_with_indicators = calculate_indicators(data)
                        
                        # ÎØ∏Îãà Ï∞®Ìä∏ ÏÉùÏÑ±
                        mini_fig = go.Figure()
                        mini_fig.add_trace(go.Candlestick(
                            x=data.index[-60:],  # ÏµúÍ∑º 60Ïùº (ÌõÑÌñâÏä§Ìå¨ ÌëúÏãú ÏúÑÌï¥)
                            open=data['Open'][-60:],
                            high=data['High'][-60:],
                            low=data['Low'][-60:],
                            close=data['Close'][-60:],
                            increasing_line_color='red',
                            decreasing_line_color='blue',
                            increasing_fillcolor='red',
                            decreasing_fillcolor='blue',
                            showlegend=False,
                            name='Í∞ÄÍ≤©'
                        ))
                        
                        # Ïù¥ÎèôÌèâÍ∑†ÏÑ† Ï∂îÍ∞Ä
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['MA20'][-60:],
                            name='MA20',
                            line=dict(color='orange', width=1)
                        ))
                        
                        # Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Ï∂îÍ∞Ä
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['BB_Upper'][-60:],
                            name='BBÏÉÅÎã®',
                            line=dict(color='gray', width=1, dash='dash'),
                            showlegend=False
                        ))
                        
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['BB_Lower'][-60:],
                            name='BBÌïòÎã®',
                            line=dict(color='gray', width=1, dash='dash'),
                            fill='tonexty',
                            fillcolor='rgba(128, 128, 128, 0.1)',
                            showlegend=False
                        ))
                        
                        # ÌõÑÌñâÏä§Ìå¨ Ï∂îÍ∞Ä (Ï£ºÌô©ÏÉâ Ï†êÏÑ†)
                        mini_fig.add_trace(go.Scatter(
                            x=data.index[-60:],
                            y=data_with_indicators['Ichimoku_Lagging'][-60:],
                            name='ÌõÑÌñâÏä§Ìå¨',
                            line=dict(color='orange', width=2, dash='dot')
                        ))
                        
                        mini_fig.update_layout(
                            height=250,
                            margin=dict(l=0, r=0, t=0, b=0),
                            xaxis_rangeslider_visible=False,
                            showlegend=True,
                            legend=dict(
                                orientation="h",
                                yanchor="bottom",
                                y=1.02,
                                xanchor="right",
                                x=1,
                                font=dict(size=8)
                            ),
                            xaxis=dict(showticklabels=False),
                            yaxis=dict(side='right')
                        )
                        
                        st.plotly_chart(mini_fig, use_container_width=True)
                        
                        # Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏöîÏïΩ
                        with st.expander("üìä Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏöîÏïΩ"):
                            latest_ind = data_with_indicators.iloc[-1]
                            
                            # Î≥ºÎ¶∞Ï†ÄÎ∞¥ÎìúÏôÄ ÌõÑÌñâÏä§Ìå¨ Î∂ÑÏÑù
                            lagging_span = latest_ind['Ichimoku_Lagging']
                            bb_upper = latest_ind['BB_Upper']
                            bb_lower = latest_ind['BB_Lower']
                            
                            # ÌõÑÌñâÏä§Ìå¨Í≥º Î≥ºÎ¶∞Ï†ÄÎ∞¥Îìú Í¥ÄÍ≥Ñ
                            if pd.notna(lagging_span):
                                if lagging_span > bb_upper:
                                    st.write("üî¥ ÌõÑÌñâÏä§Ìå¨ > BBÏÉÅÎã® (Í≥ºÎß§Ïàò)")
                                elif lagging_span < bb_lower:
                                    st.write("üü¢ ÌõÑÌñâÏä§Ìå¨ < BBÌïòÎã® (Í≥ºÎß§ÎèÑ)")
                                elif lagging_span > current_price:
                                    st.write("üü¢ ÌõÑÌñâÏä§Ìå¨ > ÌòÑÏû¨Í∞Ä (Í∞ïÏÑ∏)")
                                elif lagging_span < current_price:
                                    st.write("üî¥ ÌõÑÌñâÏä§Ìå¨ < ÌòÑÏû¨Í∞Ä (ÏïΩÏÑ∏)")
                                else:
                                    st.write("üü° ÌõÑÌñâÏä§Ìå¨ = ÌòÑÏû¨Í∞Ä")
                            
                            st.markdown("---")
                            
                            # RSI
                            rsi = latest_ind['RSI']
                            if rsi > 70:
                                st.write("üî¥ RSI: Í≥ºÎß§Ïàò")
                            elif rsi < 30:
                                st.write("üü¢ RSI: Í≥ºÎß§ÎèÑ")
                            else:
                                st.write(f"üü° RSI: {rsi:.1f}")
                            
                            # MACD
                            if latest_ind['MACD'] > latest_ind['MACD_Signal']:
                                st.write("üü¢ MACD: ÏÉÅÏäπ")
                            else:
                                st.write("üî¥ MACD: ÌïòÎùΩ")
                            
                            # Ïù¥ÎèôÌèâÍ∑†
                            if current_price > latest_ind['MA20']:
                                st.write("‚úÖ MA20 ÏúÑ")
                            else:
                                st.write("‚ùå MA20 ÏïÑÎûò")
                    else:
                        st.error(f"‚ùå {asset_name} Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®")
        
        st.markdown("---")

# ==================== ÏÉÅÏÑ∏ Î∂ÑÏÑù Î™®Îìú ====================
elif view_mode == "üîç ÏÉÅÏÑ∏ Î∂ÑÏÑù":
    # Ìã∞Ïª§ Í∞ÄÏ†∏Ïò§Í∏∞
    ticker = ASSETS[selected_category][selected_asset]

    # Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    with st.spinner(f'{selected_asset} Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...'):
        data = load_data(ticker, period=period_options[selected_period])

    if data is not None and not data.empty:
        # ÏßÄÌëú Í≥ÑÏÇ∞
        data_with_indicators = calculate_indicators(data)
        
        # Ï£ºÏöî ÏßÄÌëú ÌëúÏãú
        st.subheader(f"üìä {selected_asset} ÌòÑÌô©")
        display_metrics(data_with_indicators, selected_asset)
        
        st.markdown("---")
        
        # Ï∞®Ìä∏ ÌëúÏãú
        st.subheader(f"üìà {selected_asset} Ï∞®Ìä∏ Î∂ÑÏÑù")
        chart = create_chart(data_with_indicators, selected_asset)
        st.plotly_chart(chart, use_container_width=True)
        
        # Ï∂îÍ∞Ä Î∂ÑÏÑù Ï†ïÎ≥¥
        st.markdown("---")
        st.subheader("üîç Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏöîÏïΩ")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("#### Ïù¥ÎèôÌèâÍ∑†ÏÑ† Î∂ÑÏÑù")
            latest = data_with_indicators.iloc[-1]
            current_price = latest['Close']
            
            ma_analysis = []
            if current_price > latest['MA20']:
                ma_analysis.append("‚úÖ 20Ïùº Ïù¥ÌèâÏÑ† ÏúÑ")
            else:
                ma_analysis.append("‚ùå 20Ïùº Ïù¥ÌèâÏÑ† ÏïÑÎûò")
                
            if current_price > latest['MA50']:
                ma_analysis.append("‚úÖ 50Ïùº Ïù¥ÌèâÏÑ† ÏúÑ")
            else:
                ma_analysis.append("‚ùå 50Ïùº Ïù¥ÌèâÏÑ† ÏïÑÎûò")
                
            if current_price > latest['MA200']:
                ma_analysis.append("‚úÖ 200Ïùº Ïù¥ÌèâÏÑ† ÏúÑ")
            else:
                ma_analysis.append("‚ùå 200Ïùº Ïù¥ÌèâÏÑ† ÏïÑÎûò")
            
            for analysis in ma_analysis:
                st.write(analysis)
            
            st.markdown("#### ÏùºÎ™©Í∑†ÌòïÌëú Î∂ÑÏÑù")
            # ÏùºÎ™©Í∑†ÌòïÌëú Ïã†Ìò∏
            if current_price > latest['Ichimoku_Base']:
                st.write("‚úÖ Í∏∞Ï§ÄÏÑ†(26) ÏúÑ")
            else:
                st.write("‚ùå Í∏∞Ï§ÄÏÑ†(26) ÏïÑÎûò")
            
            if latest['Ichimoku_Conversion'] > latest['Ichimoku_Base']:
                st.write("üü¢ Ï†ÑÌôòÏÑ† > Í∏∞Ï§ÄÏÑ† (ÏÉÅÏäπ)")
            else:
                st.write("üî¥ Ï†ÑÌôòÏÑ† < Í∏∞Ï§ÄÏÑ† (ÌïòÎùΩ)")
            
            if latest['Ichimoku_A'] > latest['Ichimoku_B']:
                st.write("üü¢ Íµ¨Î¶ÑÎåÄ: ÏñëÏö¥ (ÏÉÅÏäπ)")
            else:
                st.write("üî¥ Íµ¨Î¶ÑÎåÄ: ÏùåÏö¥ (ÌïòÎùΩ)")
        
        with col2:
            st.markdown("#### Î≥¥Ï°∞ÏßÄÌëú Ïã†Ìò∏")
            
            # RSI Ïã†Ìò∏
            rsi = latest['RSI']
            if rsi > 70:
                st.write("üî¥ RSI Í≥ºÎß§Ïàò Íµ¨Í∞Ñ (Îß§ÎèÑ Í≥†Î†§)")
            elif rsi < 30:
                st.write("üü¢ RSI Í≥ºÎß§ÎèÑ Íµ¨Í∞Ñ (Îß§Ïàò Í≥†Î†§)")
            else:
                st.write("üü° RSI Ï§ëÎ¶Ω Íµ¨Í∞Ñ")
            
            # Stochastic Ïã†Ìò∏
            stoch_k = latest['Stoch_K']
            stoch_d = latest['Stoch_D']
            if stoch_k > 80 and stoch_d > 80:
                st.write("üî¥ Stochastic Í≥ºÎß§Ïàò Íµ¨Í∞Ñ")
            elif stoch_k < 20 and stoch_d < 20:
                st.write("üü¢ Stochastic Í≥ºÎß§ÎèÑ Íµ¨Í∞Ñ")
            else:
                if stoch_k > stoch_d:
                    st.write("üü¢ Stochastic ÏÉÅÏäπ ÌÅ¨Î°úÏä§")
                else:
                    st.write("üî¥ Stochastic ÌïòÎùΩ ÌÅ¨Î°úÏä§")
            
            # MACD Ïã†Ìò∏
            if latest['MACD'] > latest['MACD_Signal']:
                st.write("üü¢ MACD ÏÉÅÏäπ ÏãúÍ∑∏ÎÑê")
            else:
                st.write("üî¥ MACD ÌïòÎùΩ ÏãúÍ∑∏ÎÑê")
            
            # Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú
            if current_price > latest['BB_Upper']:
                st.write("üî¥ Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú ÏÉÅÎã® ÎèåÌåå")
            elif current_price < latest['BB_Lower']:
                st.write("üü¢ Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú ÌïòÎã® ÎèåÌåå")
            else:
                st.write("üü° Î≥ºÎ¶∞Ï†Ä Î∞¥Îìú ÎÇ¥Î∂Ä")

    else:
        st.error(f"‚ùå {selected_asset} Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ ÏûêÏÇ∞ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")

# Ìë∏ÌÑ∞
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: gray; padding: 20px;'>
    <p>üìä Îç∞Ïù¥ÌÑ∞ Ï∂úÏ≤ò: Yahoo Finance | ‚ö†Ô∏è Ìà¨Ïûê Í≤∞Ï†ïÏùÄ Î≥∏Ïù∏Ïùò Ï±ÖÏûÑÏûÖÎãàÎã§.</p>
    <p>Ïù¥ ÎåÄÏãúÎ≥¥ÎìúÎäî Ï†ïÎ≥¥ Ï†úÍ≥µ Î™©Ï†ÅÏù¥Î©∞, Ìà¨Ïûê Ï°∞Ïñ∏Ïù¥ ÏïÑÎãôÎãàÎã§.</p>
</div>
""", unsafe_allow_html=True)
